include "list.pixi"

fn in($channel_id) {
    $this = new()
    $this.channel_id = $channel_id

    $this.gen = { // $this, $channels, $frames, $in_channels
        $this = $1
        $channels = $2
        $frames = $3
        $in_channels = $4

        if $in_channels >= 0 {
            copy($channels[0], $in_channels[$this.channel_id])
            ret (1)
        } else {
            ret (0)
        }
    }

    ret ($this)
}

fn mix() {
    $this = new()
    $this.signals = -1
    $this.counter = 0

    $this.join = { // $this, $sig
        $this = $1
        $sig = $2
        $this.counter + 1
        $this.signals = _($sig, $this.signals)
    }

    $this.gen = { // $this, $channels, $frames, $in_channels
        $this = $1
        $frames = $2
        $in_channels = $3

        if $this.Buf == 0 {
            $this.Buf = new($frames, 1, FLOAT32)
        }
        clean($this.Buf)

        $signals = $this.signals
        $i = 0 while $i < $this.counter {
            $i + 1
            $sig = $signals.Head
            $signals = $signals.Tail

            $sig.gen($sig, $frames, $in_channels)
            op_cc(OP_ADD, $this.Buf, $sig.Buf, $frames)
        }
    }

    ret ($this)
}

fn j($proc, $sig) {
    $proc.join($proc, $sig)
}
