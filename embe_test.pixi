include "embe.pixi"
include "embe/comb.pixi"

show_memory_debug_messages(0)

$o1 = osc_sqr(110, 0.2)
$o2 = osc_sin(660, 0.1)
$o3 = osc_noise(0.1)
$in = in(0)

// Create mixer
$m = mix()

// Join ("j") our oscillators to the mixer
j($m, $o1)
j($m, $o2)
j($m, $o3)
j($m, $in)

// Create band-pass filter with cutoff frequency == 110Hz
// and resonance value = 100% (if we will use value > 100)
// filter will start to self-oscillate
$hz0 = 330
$hz = $hz0

$ws = waveshaper({
    $v = $1 * cos(M_PI * $1)
    ret ($v)
})


$f = comb(110, 0.98)
j($f, $m)
j($ws, $f)
$bp = flt_lp($hz, 80)
j($bp, $ws)

//$lfo = lfo()
//a($f, 'Freq', $lfo)

// Create visualizer
$v = vis_fft()

// Join our filter to visualizer
j($v, $bp)

// Send our filter to the output
out($bp)

$d = 1
while (1) {
    // Some cutoff modulation
    if TICK > 44100 / 4 {
        TICK - 44100 / 4
        $hz * pow(2, $d / 12)

        if $hz > 44100 / 2 {
            $hz = $hz0
        }

        $f.Freq = $hz
    }

    // Some visualization
    $v.render($v)

    while( get_event() ) { if EVT[ EVT_TYPE ] == EVT_QUIT { halt } }
}
