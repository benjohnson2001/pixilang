include "embe.pixi"
include "embe/utils.pixi"
include "embe/comb.pixi"
include "embe/biquad.pixi"
include "embe/osc.pixi"
include "embe/mod.pixi"
include "embe/vis.pixi"
include "embe/waveshaper.pixi"

//set_pixel_size(WINDOW_XSIZE / 240)
resize(get_screen(), WINDOW_XSIZE, WINDOW_YSIZE)

// Create mixer
$m = mix()
//$noise = osc_noise(0.01)
//$noise = osc_sqr(60, 0.001)
$noise = osc_noise(0.1)
//$noise = in(0)

$i = 1 while ($i <= 16) {
    $comb = comb($i * 240, 0.999)
    $bp = bq_bp($i * 60 , 0.9996, 0.25 / $i)
    j($comb, $noise)
    j($bp, $comb)
    j($m, $bp)
    $i + 1
}

//$bp = bq_bp(1200, 0.8, 0.5)

//$o1 = osc_sqr(110, 0.1)
//$o2 = osc_sin(660, 0.1)
//$o3 = osc_noise(0.1)
//$in = in(0)


// Join ("j") our oscillators to the mixer
//j($m, $o1)
//j($m, $o2)
//j($m, $o3)
//j($m, $in)

// Create band-pass filter with cutoff frequency == 110Hz
// and resonance value = 100% (if we will use value > 100)
// filter will start to self-oscillate

$ws = waveshaper({
    $v = $1
    if $v > 0.99 {
        $v = 0.99
    }
    if $v < -0.99 {
        $v = -0.99
    }
    ret ($v)
})

//j($bp, $m)
j($ws, $m)

// Create visualizer
$v = vis_fft()
// Join our filter to visualizer
j($v, $ws)


// Send our filter to the output
out($ws)

while (1) {

    //lfo($bp, "Freq")
    ar($noise, "Amp")
    // Some visualization
    $v.render($v)

    while( get_event() ) { if EVT[ EVT_TYPE ] == EVT_QUIT { halt } }
}
